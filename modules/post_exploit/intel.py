# modules/post_exploit/intel.py
import subprocess, os, json
from core.utils import now_iso, ensure_dir

POST_DIR = os.path.join("data","post_exploit")
ensure_dir(POST_DIR)

COMMANDS = {
    "whoami": ["whoami"],
    "id": ["id"],
    "uname": ["uname","-a"],
    "hostname": ["hostname"],
    "proc": ["ps","-ef"],
    "netstat": ["ss","-tunlp"]
}

def collect_post_intel():
    results = {}
    for name, cmd in COMMANDS.items():
        try:
            out = subprocess.check_output(cmd, stderr=subprocess.STDOUT, text=True, timeout=10)
            results[name] = out.strip()
        except Exception as e:
            results[name] = f"Error: {e}"
    fname = os.path.join(POST_DIR, f"post_intel_{now_iso().replace(':','-')}.json")
    with open(fname,"w",encoding="utf-8") as f:
        json.dump(results, f, indent=2)
    return results
